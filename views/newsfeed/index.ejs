<%- include('../partials/navbar') %>
<div class="content-wrapper">
<%- include('../partials/flash') %>
<div class="container-fluid p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0"><i class="bi bi-newspaper me-2"></i>Newsfeed</h5>
        <% if (user.role === 'alumni' || user.role === 'admin') { %>
            <a href="/newsfeed/create" class="btn btn-primary btn-sm">
                <i class="bi bi-plus-circle"></i>
            </a>
        <% } %>
    </div>
    <% if (posts && posts.length > 0) { %>
        <% posts.forEach(post => { %>
        <div class="post-card mb-3" data-post-id="<%= post.id %>">
            <div class="post-header">
                <a href="/profile/<%= post.user_id %>" class="text-decoration-none">
                    <div class="post-author">
                        <% if (post.profile_picture) { %>
                            <img src="/<%= post.profile_picture %>" alt="Profile">
                        <% } else { %>
                            <div class="avatar-placeholder"><%= post.name.charAt(0).toUpperCase() %></div>
                        <% } %>
                        <div>
                            <strong><%= post.name %></strong>
                            <%- getRoleBadge(post.role) %>
                            <small class="text-muted d-block"><%= timeAgo(post.created_at) %></small>
                        </div>
                    </div>
                </a>
            </div>
            <div class="post-content">
                <p><%= post.content %></p>
                <% if (post.image) { %>
                    <img src="/<%= post.image %>" alt="Post" class="post-image">
                <% } %>
            </div>
            <div class="post-footer">
                <button class="btn btn-sm btn-light like-btn" onclick="likePost(<%= post.id %>)">
                    <i class="bi bi-heart"></i> <span class="like-count"><%= post.likes_count %></span>
                </button>
                <button class="btn btn-sm btn-light"><i class="bi bi-chat"></i> Comment</button>
                <button class="btn btn-sm btn-light"><i class="bi bi-share"></i> Share</button>
            </div>
        </div>
        <% }); %>
    <% } else { %>
        <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <p>No posts yet</p>
        </div>
    <% } %>
</div>
</div>
<%- include('../partials/bottom-nav') %>
<script>
function likePost(postId) {
    fetch('/api/like-post', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ post_id: postId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            const card = document.querySelector(`[data-post-id="${postId}"]`);
            const likeCount = card.querySelector('.like-count');
            likeCount.textContent = data.likes_count;
            const likeBtn = card.querySelector('.like-btn i');
            likeBtn.classList.toggle('bi-heart');
            likeBtn.classList.toggle('bi-heart-fill');
            likeBtn.classList.toggle('text-danger');
        }
    });
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/app.js"></script>